### 2.5.3 应当启用DIM度量

**级别：** 建议

**适用版本：** 全部

**规则说明：**

DIM（Dynamic Integrity Measurement）动态完整性度量特性是内核提供的运行时代码段完整性度量功能。开启DIM后，可基于用户自定义的策略为内核、内核模块和应用程序提供运行时完整性度量，度量结果可被用于本地以及远程完整性证明。

系统未开启DIM度量功能时，无法识别到攻击者对程序内存中代码段的篡改行为，导致系统面临代码段被注入shellcode的安全风险。

DIM的策略配置与具体环境有关，通常情况下只针对内核、内核模块以及高权限进程开启该保护。如果策略配置不当，可能导致性能及内存开销过大，建议用户根据自身情况决定是否开启DIM，并配置正确的策略。

**规则影响：**

* 开启DIM度量会导致系统启动时间和文件访问时间有轻微增加。
* 如果策略配置不当（如度量范围过大或度量间隔太短），可导致性能开销太高，影响业务正常运行。

**检查方法：**

* 检查是否安装了DIM软件包，如果返回结果没有dim和dim_tools则表示dim软件包安装不全：

  ```bash
  # yum list installed | grep dim
  ```

* 检查是否加载了DIM内核模块，如果没有dim_monitor和dim_core则表示dim内核模块加载不全：

  ```bash
  # lsmod | grep dim
  ```

* 检查是否配置了DIM度量策略，如果内容为空则表示没有配置DIM策略：

  ```bash
  # cat /etc/dim/policy
  ```

* 确认DIM开启并正确配置了策略后，查看/sys/kernel/security/dim/runtime_measurement_count文件中存储的度量记录数，如果该值大于1，则表示DIM策略已经生效：

  ```bash
  # cat /sys/kernel/security/dim/runtime_measurements_count
  ```

**修复方法：**

* 安装DIM软件包：

  ```bash
  # yum install dim dim_tools
  ```

* 加载DIM内核模块：

  ```bash
  # modprobe dim_core
  # modprobe dim_monitor
  ```

* 使用dim_gen_baseline生成静态基线，可根据实际需求为内核、内核模块或可执行文件生成静态基线。以可执行文件/bin/bash为例：

  ```bash
  # mkdir -p /etc/dim/digest_list
  # dim_gen_baseline /bin/bash -o /etc/dim/digest_list/test.hash
  ```

* 配置度量策略，写入到/etc/dim/policy中：

  ```bash
  # echo "measure obj=BPRM_TEXT path=/bin/bash" > /etc/dim/policy
  ```

* 触发动态基线建立

  ```bash
  # echo 1 > /sys/kernel/security/dim/baseline_init
  ```

* 设置度量间隔时间：

  ```bash
  # echo 1 > /sys/kernel/security/dim/interval
  ```